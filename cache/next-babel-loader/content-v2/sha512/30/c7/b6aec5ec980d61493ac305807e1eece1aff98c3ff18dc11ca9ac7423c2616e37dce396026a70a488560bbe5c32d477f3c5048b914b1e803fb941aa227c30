{"ast":null,"code":"import { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport Error from '../_error';\nimport GoodsListTitle from '../../src/components/Goods/GoodsListTitle';\nimport GoodsSingle from '../../src/components/Goods/GoodsSingle';\nimport Seo from '../../src/components/Seo/Seo';\nimport { getCockpitCollection } from '../../src/utils/getCockpitData';\nimport { SEO_ITEMS, DEFAULT_DESCRIPTION } from '../../src/constants/seoItems';\nimport { LANGUAGES } from '../../src/constants/languages';\nimport getMoySkladData from '../../src/utils/getMoySkladData';\nimport { useEffect, useContext } from 'react';\nimport { currencyContext } from '../../src/context/currencyContext';\n\nconst SingleGoodsPage = ({\n  goodsProps,\n  subCollection,\n  locale\n}) => {\n  const {\n    USDRate,\n    currency,\n    currencyRate\n  } = useContext(currencyContext);\n  useEffect(() => {\n    if (goodsProps && false) {\n      // const code = goodsProps.link?.replace('/', '') as string;\n      const price = +goodsProps.price;\n      fbq('track', 'ViewContent', {\n        content_type: 'product',\n        content_ids: goodsProps.id,\n        currency: currency.toString() === 'UAH' ? 'USD' : currency.toString(),\n        value: currency.toString() === 'UAH' ? price / USDRate : price / currencyRate\n      });\n    }\n  }, [goodsProps, USDRate, currency, currencyRate]);\n  if (!goodsProps) return /*#__PURE__*/_jsx(Error, {});\n  const collectionLink = LANGUAGES[locale].path + '/collections' + goodsProps.collectionLink;\n  const goodLink = LANGUAGES[locale].path + '/goods' + goodsProps.link;\n  const breadcrumbs = [{\n    title: SEO_ITEMS[locale].indexPage.breadcrumbName,\n    link: SEO_ITEMS[locale].indexPage.link\n  }, {\n    title: goodsProps.collectionTitle,\n    link: collectionLink\n  }];\n\n  if (subCollection) {\n    const subCollectionLink = LANGUAGES[locale].path + '/collections' + '/subcollections' + subCollection.link;\n    breadcrumbs.push({\n      title: subCollection.title,\n      link: subCollectionLink\n    });\n  }\n\n  return /*#__PURE__*/_jsxs(\"div\", {\n    className: \"goods-page\",\n    children: [/*#__PURE__*/_jsx(Seo, {\n      title: goodsProps.title,\n      description: goodsProps.description || DEFAULT_DESCRIPTION[locale],\n      breadcrumbs: [...breadcrumbs, {\n        title: goodsProps.title,\n        link: goodLink\n      }],\n      lang: locale,\n      path: process.env.NEXT_PUBLIC_SITE_URL + goodLink,\n      product: {\n        id: goodsProps.id,\n        name: goodsProps.title,\n        image: `/_next/image?url=${process.env.NEXT_PUBLIC_COCKPIT_URL}${goodsProps.photo}&w=1800&q=75`,\n        price: goodsProps.price,\n        collection: goodsProps.collectionTitle\n      }\n    }), /*#__PURE__*/_jsx(GoodsListTitle, {}), /*#__PURE__*/_jsx(GoodsSingle, _objectSpread({}, goodsProps))]\n  });\n};\n\nexport const getServerSideProps = async ({\n  locale,\n  defaultLocale,\n  query\n}) => {\n  var _curGoods$secondImage, _curGoods$subCollecti, _curGoods$subCollecti2, _curGoods$subCollecti3;\n\n  const filter = `filter[link]=/${query.goods}&populate=1`;\n  const goodsData = await getCockpitCollection('Goods', filter);\n  const curGoods = goodsData.total ? goodsData.entries[0] : null;\n  const moySkladGoods = await getMoySkladData(`remap/1.2/entity/variant?filter=code~=${query.goods}`);\n  const ids = [];\n  const stockPromises = moySkladGoods === null || moySkladGoods === void 0 ? void 0 : moySkladGoods.rows.map(({\n    id\n  }) => {\n    ids.push(id);\n    return getMoySkladData(`remap/1.2/report/stock/all?filter=variant=https://online.moysklad.ru/api/remap/1.2/entity/variant/${id};quantityMode=all`);\n  });\n  const data = await Promise.all(stockPromises);\n  const availableIdsObjects = data.map((item, idx) => {\n    return Array.isArray(item.rows) && item.rows.length && item.rows[0].quantity >= 0 ? {\n      id: ids[idx],\n      forOrder: item.rows[0].quantity === 0\n    } : false;\n  }).filter(id => id);\n  const availableIds = availableIdsObjects.map(({\n    id\n  }) => id);\n  const sizes = moySkladGoods === null || moySkladGoods === void 0 ? void 0 : moySkladGoods.rows.filter(({\n    id\n  }) => availableIds.includes(id)).map(row => {\n    var _availableIdsObjects$;\n\n    const sizes = row.characteristics.filter(c => c.name === 'Размер').map(c => c.value);\n    const forOrder = (_availableIdsObjects$ = availableIdsObjects.find(({\n      id\n    }) => id === row.id)) === null || _availableIdsObjects$ === void 0 ? void 0 : _availableIdsObjects$.forOrder;\n    return sizes.length && {\n      value: sizes[0],\n      forOrder: forOrder\n    };\n  }).filter(size => size);\n  const sizeOrder = ['XS', 'S', 'M', 'L', 'XL'];\n  const orderedSizes = sizes.sort(({\n    value: aValue\n  }, {\n    value: bValue\n  }) => sizeOrder.indexOf(bValue) - sizeOrder.indexOf(aValue)).reverse();\n  const keys = new Set();\n  const uniqueSizes = orderedSizes.filter(record => {\n    const cols = Object.keys(record).sort();\n    const key = cols.map(field => record[field]).join('\\x00');\n    const has = keys.has(key);\n    if (!has) keys.add(key);\n    return !has;\n  });\n  const goodsProps = curGoods ? {\n    id: curGoods._id,\n    title: locale === defaultLocale ? curGoods.title : curGoods.title_en,\n    link: curGoods.link,\n    description: locale === defaultLocale ? curGoods.description : curGoods.description_en,\n    materials: locale === defaultLocale ? curGoods.consist : curGoods.consist_en,\n    price: curGoods.price,\n    stockPrice: curGoods.stockPrice,\n    sizes: uniqueSizes,\n    photo: curGoods.previewImage.path,\n    secondPhoto: (curGoods === null || curGoods === void 0 ? void 0 : (_curGoods$secondImage = curGoods.secondImage) === null || _curGoods$secondImage === void 0 ? void 0 : _curGoods$secondImage.path) || null,\n    otherPhotos: curGoods.otherImages,\n    isExclusive: curGoods.isExclusive,\n    collectionLink: curGoods.collection.link,\n    collectionTitle: curGoods.collection.display\n  } : null;\n  const subCollection = {\n    link: curGoods === null || curGoods === void 0 ? void 0 : (_curGoods$subCollecti = curGoods.subCollection) === null || _curGoods$subCollecti === void 0 ? void 0 : _curGoods$subCollecti.link,\n    title: locale === defaultLocale ? curGoods === null || curGoods === void 0 ? void 0 : (_curGoods$subCollecti2 = curGoods.subCollection) === null || _curGoods$subCollecti2 === void 0 ? void 0 : _curGoods$subCollecti2.title : curGoods === null || curGoods === void 0 ? void 0 : (_curGoods$subCollecti3 = curGoods.subCollection) === null || _curGoods$subCollecti3 === void 0 ? void 0 : _curGoods$subCollecti3.title_en\n  };\n  if (curGoods.isVisible === false) return {\n    redirect: {\n      destination: '/404',\n      permanent: false\n    }\n  };\n  return {\n    props: {\n      locale,\n      goodsProps,\n      subCollection: curGoods !== null && curGoods !== void 0 && curGoods.subCollection ? subCollection : null\n    }\n  };\n};\nexport default SingleGoodsPage;","map":null,"metadata":{},"sourceType":"module"}